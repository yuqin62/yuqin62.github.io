<!DOCTYPE html>
<html>
<head>
    <!--<title>Project 4</title>-->
    <style>
        body {
            padding: 30px;
            width: 1000px;
            margin: auto;
            text-align: left;
            font-weight: 300;
            font-family: Arial, sans-serif;
        }
        h1, h2, h3 {
          font-family: 'Source Sans Pro', sans-serif;
        }
        h3 {
            font-size: 18px;
            font-weight: bold;
        }
        p {
            font-family: 'Source Sans Pro', sans-serif;
            text-align: center;
            font-size: 15px;
        }
        .center {
            text-align: center;
        }
        .image-row {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .image-small {
            margin: 20px;
            width: 150px;
            height: auto;
        }
        .image-medium {
            margin: 5px;
            width: 240px;
            height: auto;
        }
        .image-medium-3 {
        margin: 5px;
        width: 240px;
        height: auto;
        }
        .image-medium-4 {
        margin: 3px;
        width: 165px;
        height: auto;
        }
        .image-medium-5 {
        margin: 1.5px;
        width: 130px;
        height: auto;
        }
        .image-large {
            margin: 10px;
            width: 600px;
            height: auto;
        }
        figcaption {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 12px;
            font-weight: normal;
            text-align: center;
            margin-top: 5px;
        }    
    </style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <h1 align="middle">Project 4: [Auto]Stitching Photo Mosaics</h1>
    <h1 align="middle">Part A: Image Warping and Mosaicing Image</h1>
    <h2 align="middle">Yuqin Jiao</h2>
    <br>
    <h2 align="middle">Overview</h2>
    <p>
        This project is for taking pictures, selecting corresponding points from the two images, then compute homography, warping im1 to im2, 
        blending the two images into a mosaic.
    </p>
    <h2 align="middle">Part 1: Shoot the Pictures</h2>
    <p>
        For part 1, I took 4 pair of pictures, with fixing the center of projection (COP) and rotating my camera while capturing photos. 
        Then I selected corresponding points on both images.
    </p>
    <div class="image-row">
        <figure>
            <img class="image-medium-3" src="media/figure1_1_1.jpg" alt="Description of figure1_1">
            <figcaption>[figure1_1_1] Midway Triangulation</figcaption>
        </figure>
        <figure>
            <img class="image-medium-3" src="media/figure1_1_2.jpg" alt="Description of figure1_2">
            <figcaption>[figure1_1_2] Triangulation on Image1</figcaption>
        </figure>
    </div>
    <br>
    <div class="image-row">
        <figure>
            <img class="image-medium-3" src="media/figure1_2_1.jpg" alt="Description of figure1_1">
            <figcaption>[figure1_2_1] Midway Triangulation</figcaption>
        </figure>
        <figure>
            <img class="image-medium-3" src="media/figure1_2_2.jpg" alt="Description of figure1_2">
            <figcaption>[figure1_2_2] Triangulation on Image1</figcaption>
        </figure>
    </div>
    <br>
    <div class="image-row">
        <figure>
            <img class="image-medium-3" src="media/figure1_3_1.jpg" alt="Description of figure1_1">
            <figcaption>[figure1_3_1] Midway Triangulation</figcaption>
        </figure>
        <figure>
            <img class="image-medium-3" src="media/figure1_3_2.jpg" alt="Description of figure1_2">
            <figcaption>[figure1_3_2] Triangulation on Image1</figcaption>
        </figure>
    </div>
    <br>
    <div class="image-row">
        <figure>
            <img class="image-medium-3" src="media/figure1_4_1.jpg" alt="Description of figure1_1">
            <figcaption>[figure1_4_1] Midway Triangulation</figcaption>
        </figure>
        <figure>
            <img class="image-medium-3" src="media/figure1_4_2.jpg" alt="Description of figure1_2">
            <figcaption>[figure1_4_2] Triangulation on Image1</figcaption>
        </figure>
    </div>
    <br>

    <h2 align="middle">Part 2: Recover Homographies"</h2>
    <p>
        The theory for recovering homographies is explained below:
    </p>
    <p>
        The transformation is a homography: \( q = Hp \), with \( q \) and \( h \) in homogeneous coordinates:
    </p>
    <div class="math">
        \[
        \begin{pmatrix}
        wq_1 \\
        wq_2 \\
        w
        \end{pmatrix}
        =
        \begin{pmatrix}
        a & b & c \\
        d & e & f \\
        g & h & 1
        \end{pmatrix}
        \begin{pmatrix}
        p_1 \\
        p_2 \\
        1
        \end{pmatrix}
        \]
    </div>
    <p>
        This implies that \( w = g p_1 + h p_2 + 1 \). We can substitute to get the relations:
    </p>
    <div class="math">
        \[
        (g p_1 + h p_2 + 1) q_1 = a p_1 + b p_2 + c
        \]
        \[
        (g p_1 + h p_2 + 1) q_2 = d p_1 + e p_2 + f
        \]
    </div>
    <p>Or equivalently:</p>
    <div class="math">
        \[
        g(p_1 q_1) + h(p_2 q_1) + q_1 = a p_1 + b p_2 + c
        \]
        \[
        g(p_1 q_2) + h(p_2 q_2) + q_2 = d p_1 + e p_2 + f
        \]
    </div>
    <p>Finally, stacking this into matrix form, we get:</p>
    <div class="math">
        \[
        \begin{pmatrix}
        p_1 & p_2 & 1 & 0 & 0 & 0 & -p_1 q_1 & -p_2 q_1 \\
        0 & 0 & 0 & p_1 & p_2 & 1 & -p_1 q_2 & -p_2 q_2
        \end{pmatrix}
        \begin{pmatrix}
        a \\
        b \\
        c \\
        d \\
        e \\
        f \\
        g \\
        h
        \end{pmatrix}
        =
        \begin{pmatrix}
        q_1 \\
        q_2
        \end{pmatrix}
        \]
    <p>Generally, I used H = computeH(im1_pts,im2_pts) to compute the homography matrix from im1 warping to im2.</p>
    </div>
    
    <h2 align="middle">Part 3: Warp the Images</h2>
    <p>
        To warp the images, I used the homography matrix H to map the canvas coordinates back to the original image space. 
        First, I created a canvas with dimensions based on the bounding box, then I computed the corresponding points in the 
        original image by applying the inverse of H. Using RegularGridInterpolator, I interpolated the pixel values for the 
        red, green, and blue channels separately. I then combined these channels to produce the final warped image and created 
        an alpha mask to mark valid pixels in the result.
    </p>

    <h2 align="middle">Part 4: Image Rectification</h2>
    <p>
        For image rectification, I selected four corners of a rectangular object in the image (im1_pts) and defined the corresponding target points (im2_pts) as a perfect rectangle. 
        Using the homography computed between these points (the same function I used above), I warped the image to correct the perspective, making the object appear rectangular. 
        I tested this with three pairs of rectification images to ensure the homography and warping were working correctly.
    </p>
    <div class="image-row">
        <figure>
            <img class="image-medium-3" src="media/figure2_1_1.jpg" alt="Description of figure2_1">
            <figcaption>[figure2_1_1] Population Average Face</figcaption>
        </figure>
        <figure>
            <img class="image-medium-3" src="media/figure2_1_2.jpg" alt="Description of figure2_2">
            <figcaption>[figure2_1_2] My Face warped into Average Shape</figcaption>
        </figure>
    </div>
    <div class="image-row">
        <figure>
            <img class="image-medium-3" src="media/figure2_2_1.jpg" alt="Description of figure2_1">
            <figcaption>[figure2_2_1] Population Average Face</figcaption>
        </figure>
        <figure>
            <img class="image-medium-3" src="media/figure2_2_2.jpg" alt="Description of figure2_2">
            <figcaption>[figure2_2_2] My Face warped into Average Shape</figcaption>
        </figure>
    </div>
    <div class="image-row">
        <figure>
            <img class="image-medium-3" src="media/figure2_3_1.jpg" alt="Description of figure2_1">
            <figcaption>[figure2_3_1] Population Average Face</figcaption>
        </figure>
        <figure>
            <img class="image-medium-3" src="media/figure2_3_2.jpg" alt="Description of figure2_2">
            <figcaption>[figure2_3_2] My Face warped into Average Shape</figcaption>
        </figure>
    </div>
    

    <h2 align="middle">Part 5: Blend the images into a mosaic</h2>
    <p>
        To blend the images into a mosaic, I warped the first image (im1) into the coordinate system of the 
        second image (im2) using the homography matrix H. I computed the bounding box for the warped image to 
        determine the size of the overall canvas, ensuring that both images fit. I then created an alpha mask for 
        each image to handle blending. The alpha mask for the warped image was generated by mapping its pixels, and 
        for the second image, I applied a mask with reduced weights near the edges to avoid sharp seams. Using the 
        alpha masks, I computed feather weights that gradually decrease toward the edges of each image. These 
        weights were applied during the blending process to perform a weighted average of the two images at 
        every pixel, resulting in a smooth transition between them. The final mosaic was normalized by the 
        accumulated weights and clipped to ensure valid pixel values. Then, I displayed the feathered 
        alpha masks and the resulting mosaic with smooth blending.
    </p>
    <div class="image-row">
        <figure>
            <img class="image-large" src="media/figure3_1.jpg" alt="Description of figure2_1">
            <figcaption>[figure3_1] Caricature Image with Alpha = 1.5</figcaption>
        </figure>
    </div>
    <div class="image-row">
        <figure>
            <img class="image-large" src="media/figure3_2.jpg" alt="Description of figure2_1">
            <figcaption>[figure3_2] Caricature Image with Alpha = 1.5</figcaption>
        </figure>
    </div>
    <div class="image-row">
        <figure>
            <img class="image-large" src="media/figure3_3.jpg" alt="Description of figure2_1">
            <figcaption>[figure3_3] Caricature Image with Alpha = 1.5</figcaption>
        </figure>
    </div>
    <div class="image-row">
        <figure>
            <img class="image-large" src="media/figure3_4.jpg" alt="Description of figure2_1">
            <figcaption>[figure3_4] Caricature Image with Alpha = 1.5</figcaption>
        </figure>
    </div>

    <h2 align="middle">Bells and Whistles 1</h2>
    <p>
        For part 1 of Bells and Whistles, I chose a face from difference gender and ethnicity to try morphing.
    </p>
    <div class="image-row">
        <figure>
            <img class="image-medium-3" src="media/image1.jpg" alt="Description of figure2_1">
            <figcaption>[figure6_1] Image1 from FEI Dataset</figcaption>
        </figure>
        <figure>
            <img class="image-medium-3" src="media/image2.jpg" alt="Description of figure2_2">
            <figcaption>[figure6_2] Image2 from FEI Dataset</figcaption>
        </figure>
    </div>
    <div class="image-row">
        <figure>
            <img class="image-medium-3" src="media/output7_1.jpg" alt="Description of figure2_1">
            <figcaption>[figure6_3] Morphing just the Shape(warping)</figcaption>
        </figure>
        <figure>
            <img class="image-medium-3" src="media/output7_2.jpg" alt="Description of figure2_2">
            <figcaption>[figure6_4] Morphing just the Appearance(color)</figcaption>
        </figure>
        <figure>
            <img class="image-medium-3" src="media/output7_3.jpg" alt="Description of figure2_3">
            <figcaption>[figure6_5] Morphing both Shape and Color</figcaption>
        </figure>
    </div>

    <h2 align="middle">Bells and Whistles 2</h2>
    <p>
        For part 2 of Bells and Whistles, I made a video morphing five skaters' faces. The video theme is "Romeo and Juliet", which means the 
        five skaters all have had skating programs using "Romeo and Juliet" theme.
    <br>
        I believe the "Romeo and Juliet" theme is not only about LOVE, it's more about FREEDOM.
    </p>
    <br>
    <iframe width="560" height="315" 
        src="https://www.youtube.com/embed/huIg69GEYS8" 
        title="YouTube video player" 
        frameborder="0" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
        allowfullscreen>
    </iframe>

</body>
</html>

